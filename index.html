<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - Admin Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        /* Dashboard & Profit */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #total-profit { font-size: 2.5rem; font-weight: bold; }
        
        /* Formular */
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; }
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #94a3b8; color: white; display: none; }

        /* Historie & Offene Trades */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .status-open { color: orange; font-weight: bold; }
        .status-closed { color: gray; }
        .action-btns button { padding: 5px 10px; margin-right: 5px; font-size: 0.8rem; }
        
        /* Graph */
        canvas { max-height: 300px; }
        .filter-section { margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="form-title">Neuen Trade erstellen</h1>
    
    <div class="card">
        <form id="trade-form">
            <input type="hidden" id="edit-id">
            <div>
                <label>Datum & Uhrzeit</label>
                <input type="datetime-local" id="trade-date" required>
            </div>
            <div>
                <label>Symbol (z.B. BTC/USDT)</label>
                <input type="text" id="trade-symbol" placeholder="BTC/USDT" required>
            </div>
            <div>
                <label>Profit/Loss (€)</label>
                <input type="number" id="trade-profit" step="0.01" value="0">
            </div>
            <div>
                <label>Status</label>
                <select id="trade-status">
                    <option value="Offen">Offen</option>
                    <option value="Geschlossen">Geschlossen</option>
                </select>
            </div>
            <div class="full-width">
                <label>Setup Link (z.B. TradingView)</label>
                <input type="url" id="trade-setup" placeholder="https://...">
            </div>
            <div id="result-container" class="full-width" style="display:none;">
                <label>Ergebnis Link</label>
                <input type="url" id="trade-result" placeholder="https://...">
            </div>
            <div class="full-width">
                <label>Notizen</label>
                <textarea id="trade-notes" rows="3"></textarea>
            </div>
            <button type="submit" class="btn-save" id="btn-submit">Trade speichern</button>
            <button type="button" class="btn-cancel" id="btn-cancel" onclick="resetForm()">Abbrechen</button>
        </form>
    </div>

    <hr style="margin: 40px 0;">

    <div class="dashboard">
        <div class="card">
            <h3>Gesamt Profit</h3>
            <div id="total-profit">0.00€</div>
            <div class="filter-section">
                <label>Zeitraum filtern:</label>
                <input type="date" id="filter-date" onchange="updateDashboard()">
            </div>
        </div>
        <div class="card">
            <h3>Performance Graph</h3>
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h3>Aktuell Offene Trades</h3>
        <div id="open-trades-list">Keine offenen Trades.</div>
    </div>

    <div class="card">
        <h3>Trade Historie</h3>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Symbol</th>
                        <th>Profit</th>
                        <th>Status</th>
                        <th>Links</th>
                        <th>Notiz</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let trades = JSON.parse(localStorage.getItem('trades')) || [];
    let myChart;

    const form = document.getElementById('trade-form');
    const statusSelect = document.getElementById('trade-status');
    const resultContainer = document.getElementById('result-container');

    // Toggle Ergebnis-Link Anzeige
    statusSelect.addEventListener('change', () => {
        resultContainer.style.display = statusSelect.value === 'Geschlossen' ? 'block' : 'none';
    });

    // Automatisches Datum beim Laden
    function setToday() {
        if(!document.getElementById('edit-id').value) {
            document.getElementById('trade-date').value = new Date().toISOString().slice(0, 16);
        }
    }

    form.onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const tradeData = {
            id: id ? parseInt(id) : Date.now(),
            date: document.getElementById('trade-date').value,
            symbol: document.getElementById('trade-symbol').value,
            profit: parseFloat(document.getElementById('trade-profit').value),
            status: document.getElementById('trade-status').value,
            setup: document.getElementById('trade-setup').value,
            result: document.getElementById('trade-result').value,
            notes: document.getElementById('trade-notes').value
        };

        if (id) {
            trades = trades.map(t => t.id === tradeData.id ? tradeData : t);
        } else {
            trades.push(tradeData);
        }

        localStorage.setItem('trades', JSON.stringify(trades));
        resetForm();
        updateDashboard();
    };

    function resetForm() {
        form.reset();
        document.getElementById('edit-id').value = '';
        document.getElementById('form-title').innerText = 'Neuen Trade erstellen';
        document.getElementById('btn-submit').innerText = 'Trade speichern';
        document.getElementById('btn-cancel').style.display = 'none';
        resultContainer.style.display = 'none';
        setToday();
    }

    function editTrade(id) {
        const trade = trades.find(t => t.id === id);
        document.getElementById('edit-id').value = trade.id;
        document.getElementById('trade-date').value = trade.date;
        document.getElementById('trade-symbol').value = trade.symbol;
        document.getElementById('trade-profit').value = trade.profit;
        document.getElementById('trade-status').value = trade.status;
        document.getElementById('trade-setup').value = trade.setup;
        document.getElementById('trade-result').value = trade.result;
        document.getElementById('trade-notes').value = trade.notes;

        document.getElementById('form-title').innerText = 'Trade bearbeiten';
        document.getElementById('btn-submit').innerText = 'Änderungen speichern';
        document.getElementById('btn-cancel').style.display = 'inline-block';
        resultContainer.style.display = trade.status === 'Geschlossen' ? 'block' : 'none';
        window.scrollTo(0,0);
    }

    function deleteTrade(id) {
        if(confirm('Trade wirklich löschen?')) {
            trades = trades.filter(t => t.id !== id);
            localStorage.setItem('trades', JSON.stringify(trades));
            updateDashboard();
        }
    }

    function updateDashboard() {
        const filterVal = document.getElementById('filter-date').value;
        let filteredTrades = trades.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        if(filterVal) {
            filteredTrades = filteredTrades.filter(t => t.date.startsWith(filterVal));
        }

        // Profit Anzeige & Farbe
        const total = filteredTrades.reduce((sum, t) => sum + t.profit, 0);
        const profitEl = document.getElementById('total-profit');
        profitEl.innerText = total.toFixed(2) + '€';
        profitEl.style.color = total >= 0 ? 'var(--success)' : 'var(--danger)';

        // Offene Trades Liste
        const openTrades = trades.filter(t => t.status === 'Offen');
        document.getElementById('open-trades-list').innerHTML = openTrades.length ? 
            openTrades.map(t => `<strong>${t.symbol}</strong> (${new Date(t.date).toLocaleDateString()})`).join(', ') : 
            'Keine offenen Trades.';

        // Historie Tabelle
        const historyBody = document.getElementById('history-body');
        historyBody.innerHTML = filteredTrades.slice().reverse().map(t => `
            <tr>
                <td>${t.date.replace('T', ' ')}</td>
                <td>${t.symbol}</td>
                <td style="color: ${t.profit >= 0 ? 'green' : 'red'}">${t.profit.toFixed(2)}€</td>
                <td class="${t.status === 'Offen' ? 'status-open' : 'status-closed'}">${t.status}</td>
                <td>
                    ${t.setup ? `<a href="${t.setup}" target="_blank">Setup</a>` : ''}
                    ${t.result ? ` | <a href="${t.result}" target="_blank">Ergebnis</a>` : ''}
                </td>
                <td><small>${t.notes || '-'}</small></td>
                <td class="action-btns">
                    <button onclick="editTrade(${t.id})">Edit</button>
                    <button onclick="deleteTrade(${t.id})" style="color:red">Del</button>
                </td>
            </tr>
        `).join('');

        updateChart(filteredTrades);
    }

    function updateChart(data) {
        const ctx = document.getElementById('profitChart').getContext('2d');
        const labels = data.map(t => new Date(t.date).toLocaleDateString());
        let runningProfit = 0;
        const points = data.map(t => {
            runningProfit += t.profit;
            return runningProfit;
        });

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Kapitalverlauf (€)',
                    data: points,
                    borderColor: '#2563eb',
                    tension: 0.1,
                    fill: true,
                    backgroundColor: 'rgba(37, 99, 235, 0.1)'
                }]
            }
        });
    }

    setToday();
    updateDashboard();
</script>

</body>
</html>
